<div class="flex flex-col gap-8">
  <div>
    <h2 class="text-2xl font-bold text-slate-800 mb-2">الأخطاء المبلغة</h2>
    <p class="text-slate-500 leading-relaxed">
      واجهت مشكلة؟
      <span class="text-red-600 font-bold">يرجى البحث أولاً</span>
      للتأكد من أن الخطأ لم يتم الإبلاغ عنه مسبقاً.
    </p>
  </div>

  <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow">
    <div class="bg-red-50 border-b border-red-100 p-4">
      <h3 class="font-bold text-red-700 flex items-center gap-2">
        <i class="pi pi-exclamation-triangle"></i>
        إبلاغ عن خطأ جديد
      </h3>
    </div>

    <form
      [formGroup]="form"
      (ngSubmit)="onSubmit()"
      class="p-6 flex flex-col gap-6"
    >
      <div class="flex flex-col gap-2">
        <p-floatLabel>
          <input
            pInputText
            id="title"
            formControlName="title"
            class="w-full"
            maxlength="40"
            [ngClass]="{
              'ng-invalid ng-dirty': form.get('title')?.invalid && submitted()
            }"
          />
          <label for="title">عنوان الخطأ (باختصار)</label>
        </p-floatLabel>
        @if(form.get('title')?.invalid && submitted()){
        <small class="text-red-500">العنوان مطلوب ولا يتجاوز 40 حرفاً.</small>
        }
      </div>

      <div class="flex flex-col gap-2">
        <p-floatLabel>
          <textarea
            pTextarea
            id="description"
            formControlName="description"
            rows="5"
            maxlength="300"
            class="w-full"
            style="resize: none"
            placeholder="اشرح خطوات إعادة إنتاج الخطأ..."
            [ngClass]="{
              'ng-invalid ng-dirty':
                form.get('description')?.invalid && submitted()
            }"
          ></textarea>
          <label for="description">تفاصيل الخطأ / خطوات التكرار</label>
        </p-floatLabel>
        @if(form.get('description')?.invalid && submitted()){
        <small class="text-red-500">التفاصيل مطلوبة ولا تتجاوز 300 حرف.</small>
        }
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex flex-col gap-2">
          <p-floatLabel>
            <p-autoComplete
              formControlName="category"
              [suggestions]="filteredCategories"
              (completeMethod)="searchCategory($event)"
              optionLabel="name"
              optionValue="id"
              [dropdown]="true"
              [forceSelection]="true"
              scrollHeight="200px"
              placeholder="اختر نوع الخطأ"
              styleClass="w-full"
              inputStyleClass="w-full"
              scrollHeight="10rem"
              [ngClass]="{
                'ng-invalid ng-dirty':
                  form.get('category')?.invalid && submitted()
              }"
            >
            </p-autoComplete>
            <label>نوع الخطأ</label>
          </p-floatLabel>

          @if(form.get('category')?.invalid && submitted()){
          <small class="text-red-500">الفئة مطلوبة.</small>
          }
        </div>

        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-3">
            <input
              type="file"
              id="file-upload"
              multiple
              class="hidden"
              (change)="onFileChange($event)"
              #fileInput
            />
            <p-button
              label="إرفاق لقطة شاشة"
              icon="pi pi-camera"
              severity="secondary"
              [outlined]="true"
              (onClick)="fileInput.click()"
            />
            <span class="text-sm text-slate-400">صور أو فيديو (Max 20MB)</span>
          </div>

          @if (form.get('files')?.hasError('maxTotalFileSize')) {
          <small class="text-red-500">الحجم الكلي يتجاوز 20MB</small>
          }
        </div>
      </div>

      @if(filesArray.length > 0){
      <div class="flex flex-wrap gap-2 mt-2">
        @for(file of filesArray; track file.name){
        <div
          class="bg-red-50 text-red-700 px-3 py-1 rounded-md text-sm flex items-center gap-2 border border-red-100"
        >
          <i class="pi pi-image"></i>
          <span class="max-w-[150px] truncate">{{ file.name }}</span>
        </div>
        }
      </div>
      }

      <div class="flex gap-3 pt-2 border-t border-slate-100 mt-2">
        <p-button
          label="الإبلاغ عن الخطأ"
          icon="pi pi-exclamation-circle"
          severity="danger"
          type="submit"
          [rounded]="true"
        />
        <p-button
          label="إلغاء"
          icon="pi pi-times"
          severity="secondary"
          [text]="true"
          (onClick)="reset()"
        />
      </div>
    </form>
  </div>

  <div class="flex flex-col gap-4">
    <div
      class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-3 rounded-xl border border-slate-200 shadow-sm"
    >
      <div class="w-full md:w-1/2">
        <p-iconField iconPosition="left">
          <p-inputIcon styleClass="pi pi-search" />
          <input
            type="text"
            pInputText
            [(ngModel)]="searchQuery"
            placeholder="بحث في الأخطاء المبلغة..."
            class="w-full border-none shadow-none focus:ring-0"
          />
        </p-iconField>
      </div>

      <p-selectButton
        [options]="sortOptions"
        [(ngModel)]="currentSort"
        optionLabel="label"
        optionValue="value"
        [unselectable]="true"
      />
    </div>

    <div
      class="flex flex-col gap-4 max-h-[600px] overflow-y-auto custom-scrollbar pr-2 pb-2"
    >
      @for (req of displayedRequests(); track req.id) {
      <app-request-card
        [request]="req"
        [showDescription]="true"
        [showCategory]="true"
      >
      </app-request-card>
      } @if (displayedRequests().length === 0) {
      <div
        class="text-center py-8 text-slate-400 text-sm border-2 border-dashed border-slate-100 rounded-xl"
      >
        <i class="pi pi-search text-4xl text-slate-300 mb-4 block"></i>
        <p class="text-slate-500 font-bold">لا توجد أخطاء مطابقة</p>
      </div>
      }
    </div>
  </div>
</div>
<p-toast position="bottom-left" dir="rtl"></p-toast>
